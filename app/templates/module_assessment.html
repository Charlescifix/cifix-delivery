{% extends "base.html" %}

{% block content %}
<div class="min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="modern-card mb-8">
            <div class="text-center">
                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                        <path d="M12,3L1,9L12,15L21,10.09V17H23V9M5,13.18V17.18L12,21L19,17.18V13.18L12,17L5,13.18Z" />
                    </svg>
                </div>
                <h1 class="title-secondary mb-2">{{ assessment_data.title }}</h1>
                <p class="text-gray-600 mb-4">{{ module.title }} - Week {{ module.week_no }}</p>
                <p class="text-lg text-gray-700">{{ assessment_data.description }}</p>
            </div>
        </div>

        {% if latest_attempt %}
        <!-- Previous Attempt Summary -->
        <div class="modern-card bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 mb-8">
            <h3 class="font-bold text-blue-700 mb-4">üéØ Your Best Score</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <div class="text-2xl font-bold text-blue-600">{{ latest_attempt.score }}/10</div>
                    <div class="text-sm text-gray-600">Correct Answers</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-purple-600">{{ latest_attempt.percentage }}%</div>
                    <div class="text-sm text-gray-600">Score</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-yellow-600">‚≠ê {{ latest_attempt.stars_earned }}</div>
                    <div class="text-sm text-gray-600">Stars Earned</div>
                </div>
            </div>
            {% if can_retake %}
            <p class="text-center text-blue-600 mt-4">You can retake this assessment to improve your score!</p>
            {% endif %}
        </div>
        {% endif %}

        <!-- Instructions -->
        <div class="modern-card bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 mb-8">
            <h3 class="font-bold text-green-700 mb-4">üìù Instructions</h3>
            <ul class="space-y-2 text-gray-700">
                <li class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    Answer all {{ assessment_data.questions|length }} questions
                </li>
                <li class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                    You need {{ assessment_data.scoring.passing_score }}/10 to pass
                </li>
                <li class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                    Take your time - there's no time limit!
                </li>
                <li class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                    You can retake the assessment to improve
                </li>
            </ul>
        </div>

        <!-- Assessment Form -->
        <form method="post" id="assessmentForm" class="space-y-6">
            <input type="hidden" name="start_time" id="startTime" value="">
            
            {% for question in assessment_data.questions %}
            <div class="modern-card">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        Question {{ question.id }}: {{ question.question }}
                    </h3>
                    
                    <div class="space-y-3">
                        {% for i in range(question.options|length) %}
                        <label class="flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-indigo-300 hover:bg-indigo-50 cursor-pointer transition-all">
                            <input type="radio" 
                                   name="question_{{ question.id }}" 
                                   value="{{ i }}" 
                                   class="mr-3 text-indigo-600" 
                                   required>
                            <span class="flex-grow font-medium text-gray-700">{{ question.options[i] }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Submit Section -->
            <div class="modern-card bg-gradient-to-br from-indigo-500 to-purple-600 text-white border-none">
                <div class="text-center">
                    <h3 class="text-xl font-bold mb-4">Ready to Submit?</h3>
                    <p class="mb-6 opacity-90">Make sure you've answered all questions before submitting.</p>
                    
                    <button type="submit" class="modern-btn bg-white text-indigo-600 hover:bg-gray-100 text-lg px-8 py-4">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z" />
                        </svg>
                        Submit Assessment
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Set start time when page loads
document.getElementById('startTime').value = Math.floor(Date.now() / 1000);

// Form validation
document.getElementById('assessmentForm').addEventListener('submit', function(e) {
    const totalQuestions = {{ assessment_data.questions|length }};
    let answeredQuestions = 0;
    
    for (let i = 1; i <= totalQuestions; i++) {
        const question = document.querySelector(`input[name="question_${i}"]:checked`);
        if (question) {
            answeredQuestions++;
        }
    }
    
    if (answeredQuestions < totalQuestions) {
        e.preventDefault();
        alert(`Please answer all questions! You've answered ${answeredQuestions}/${totalQuestions} questions.`);
        return false;
    }
    
    // Confirmation dialog
    const confirmed = confirm('Are you sure you want to submit your assessment? You can review your answers one more time.');
    if (!confirmed) {
        e.preventDefault();
        return false;
    }
});

// Auto-save progress (optional enhancement)
function saveProgress() {
    const answers = {};
    {% for question in assessment_data.questions %}
    const q{{ question.id }} = document.querySelector('input[name="question_{{ question.id }}"]:checked');
    if (q{{ question.id }}) {
        answers['{{ question.id }}'] = q{{ question.id }}.value;
    }
    {% endfor %}
    
    localStorage.setItem('assessment_progress_{{ module.id }}', JSON.stringify(answers));
}

// Load saved progress
function loadProgress() {
    const saved = localStorage.getItem('assessment_progress_{{ module.id }}');
    if (saved) {
        const answers = JSON.parse(saved);
        for (const [questionId, answerValue] of Object.entries(answers)) {
            const radio = document.querySelector(`input[name="question_${questionId}"][value="${answerValue}"]`);
            if (radio) {
                radio.checked = true;
            }
        }
    }
}

// Save progress on answer change
document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', saveProgress);
});

// Load progress on page load
window.addEventListener('load', loadProgress);

// Clear progress on successful submit
document.getElementById('assessmentForm').addEventListener('submit', function() {
    localStorage.removeItem('assessment_progress_{{ module.id }}');
});
</script>
{% endblock %}